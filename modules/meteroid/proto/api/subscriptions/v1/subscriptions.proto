syntax = "proto3";

package meteroid.api.subscriptions.v1;


import "api/subscriptions/v1/models.proto";
import "api/invoices/v1/models.proto";
import "api/shared/v1/shared.proto";
import "common/v1/pagination.proto";

message CreateSubscriptionsRequest {
  repeated CreateSubscription subscriptions = 1;
}

message CreateSubscriptionRequest {
  CreateSubscription subscription = 1;
}

message CreateSubscriptionsResponse {
  repeated CreatedSubscription subscriptions = 1;
}

message CreateSubscriptionResponse {
  CreatedSubscription subscription = 1;
}

message GetSubscriptionDetailsRequest {
  string subscription_id = 1;
}

message GetSubscriptionDetailsResponse {
  SubscriptionDetails subscription = 1;
}



message CancelSubscriptionRequest {
  string subscription_id = 1;
  optional string reason = 2;

  oneof effective_at {
    Immediate immediate = 3;
    BillingPeriodEnd billing_period_end = 4;
    string date = 5;
  }
  message Immediate {}
  message BillingPeriodEnd {}

}

message CancelSubscriptionResponse {
  Subscription subscription = 1;
}



message ListSubscriptionsRequest {
  optional string customer_id = 1;
  optional string plan_id = 2;
  meteroid.common.v1.Pagination pagination = 3;
  repeated SubscriptionStatus status = 4;
}

message ListSubscriptionsResponse {
  repeated Subscription subscriptions = 1;
  meteroid.common.v1.PaginationResponse pagination_meta = 2;
}


message UpdateSlotsRequest {
  string subscription_id = 1;
  string price_component_id = 2;
  int32 delta = 3;
  optional SlotUpgradeBillingMode billing_mode = 4;
}

message UpdateSlotsResponse {
  uint32 current_value = 1;
}

message GetSlotsValueRequest {
  string subscription_id = 1;
  string unit = 2;
}

message GetSlotsValueResponse {
  uint32 current_value = 1;
  // uint32 next_period_value = 2; // TODO
}

message SyncToHubspotRequest {
  repeated string subscription_ids = 1;
}

message SyncToHubspotResponse {
}

message ListSlotTransactionsRequest {
  string subscription_id = 1;
  optional string unit = 2;
  optional SlotTransactionStatus status = 3;
}

message ListSlotTransactionsResponse {
  repeated SlotTransaction transactions = 1;
}

message CancelSlotTransactionRequest {
  string transaction_id = 1;
  optional string reason = 2;
}

message CancelSlotTransactionResponse {}

message PreviewSlotUpdateRequest {
  string subscription_id = 1;
  string price_component_id = 2;
  int32 delta = 3;
}

message PreviewSlotUpdateResponse {
  int32 current_slots = 1;
  int32 new_slots = 2;
  int32 delta = 3;
  string unit = 4;
  string unit_rate = 5;

  // Proration details
  string prorated_amount = 6; // Actual prorated charge
  string full_period_amount = 7; // What they'll pay per period going forward
  int32 days_remaining = 8; // Days left in current period
  int32 days_total = 9; // Total days in period

  string effective_at = 10;
  string current_period_end = 11;
  // How much will be added to next invoice
  string next_invoice_delta = 12;
}

message GenerateCheckoutTokenRequest {
  string subscription_id = 1;
}

message GenerateCheckoutTokenResponse {
  string token = 1;
}

message ActivateSubscriptionRequest {
  string subscription_id = 1;
}

message ActivateSubscriptionResponse {
  Subscription subscription = 1;
  optional string invoice_id = 2;
}

message UpdateSubscriptionRequest {
  string subscription_id = 1;
  optional bool charge_automatically = 2;
  optional bool auto_advance_invoices = 3;
  optional uint32 net_terms = 4;
  optional string invoice_memo = 5;
  optional string purchase_order = 7;
  optional PaymentMethodsConfig payment_methods_config = 8;
}

message UpdateSubscriptionResponse {
  Subscription subscription = 1;
}

message PlanChangeComponentParameterization {
  string component_id = 1;
  optional meteroid.api.shared.v1.BillingPeriod billing_period = 2;
  optional uint32 initial_slot_count = 3;
  optional uint64 committed_capacity = 4;
}

message SchedulePlanChangeRequest {
  string subscription_id = 1;
  string new_plan_version_id = 2;
  repeated PlanChangeComponentParameterization parameterized_components = 3;
}

message SchedulePlanChangeResponse {
  string event_id = 1;
  string effective_date = 2;
}

message PreviewPlanChangeRequest {
  string subscription_id = 1;
  string new_plan_version_id = 2;
  repeated PlanChangeComponentParameterization parameterized_components = 3;
}

message PreviewPlanChangeResponse {
  repeated PlanChangeMatchedComponent matched = 1;
  repeated PlanChangeAddedComponent added = 2;
  repeated PlanChangeRemovedComponent removed = 3;
  string effective_date = 4;
}

message PlanChangeMatchedComponent {
  string product_id = 1;
  string current_name = 2;
  string new_name = 3;
  SubscriptionFee current_fee = 4;
  SubscriptionFeeBillingPeriod current_period = 5;
  SubscriptionFee new_fee = 6;
  SubscriptionFeeBillingPeriod new_period = 7;
}

message PlanChangeAddedComponent {
  string name = 1;
  SubscriptionFee fee = 2;
  SubscriptionFeeBillingPeriod period = 3;
}

message PlanChangeRemovedComponent {
  string name = 1;
  SubscriptionFee current_fee = 2;
  SubscriptionFeeBillingPeriod current_period = 3;
}

message CancelPlanChangeRequest {
  string subscription_id = 1;
}

message CancelPlanChangeResponse {}

message CancelScheduledEventRequest {
  string event_id = 1;
}

message CancelScheduledEventResponse {}

message GetUpcomingInvoiceRequest {
  string subscription_id = 1;
}

message GetUpcomingInvoiceResponse {
  UpcomingInvoice invoice = 1;
}

message UpcomingInvoice {
  string currency = 1;
  string invoice_date = 2;
  repeated meteroid.api.invoices.v1.LineItem line_items = 3;
  repeated meteroid.api.invoices.v1.CouponLineItem coupon_line_items = 4;
  repeated meteroid.api.invoices.v1.TaxBreakdownItem tax_breakdown = 5;
  int64 subtotal = 6;
  int64 subtotal_recurring = 7;
  int64 tax_amount = 8;
  int64 total = 9;
  int64 amount_due = 10;
  int64 applied_credits = 11;
  int64 discount = 12;
  string period_start = 13;
  string period_end = 14;
  optional string plan_name = 15;
  optional string due_date = 16;
  int32 net_terms = 17;
}

message GetSubscriptionComponentUsageRequest {
  string subscription_id = 1;
  string metric_id = 2;
}

message GetSubscriptionComponentUsageResponse {
  repeated UsageDataPoint data_points = 1;
  string period_start = 2;
  string period_end = 3;
}

message UsageDataPoint {
  string window_start = 1;
  string window_end = 2;
  string value = 3;
  map<string, string> dimensions = 4;
}

// Service definition
service SubscriptionsService {
  rpc CreateSubscription(CreateSubscriptionRequest) returns (CreateSubscriptionResponse);
  rpc CreateSubscriptions(CreateSubscriptionsRequest) returns (CreateSubscriptionsResponse);
  rpc GetSubscriptionDetails(GetSubscriptionDetailsRequest) returns (SubscriptionDetails);
  rpc ListSubscriptions(ListSubscriptionsRequest) returns (ListSubscriptionsResponse);
  rpc UpdateSlots(UpdateSlotsRequest) returns (UpdateSlotsResponse);
  rpc GetSlotsValue(GetSlotsValueRequest) returns (GetSlotsValueResponse);
  rpc ListSlotTransactions(ListSlotTransactionsRequest) returns (ListSlotTransactionsResponse);
  rpc CancelSlotTransaction(CancelSlotTransactionRequest) returns (CancelSlotTransactionResponse);
  rpc PreviewSlotUpdate(PreviewSlotUpdateRequest) returns (PreviewSlotUpdateResponse);
  rpc CancelSubscription(CancelSubscriptionRequest) returns (CancelSubscriptionResponse);
  rpc ActivateSubscription(ActivateSubscriptionRequest) returns (ActivateSubscriptionResponse);
  rpc SyncToHubspot(SyncToHubspotRequest) returns (SyncToHubspotResponse);
  rpc GenerateCheckoutToken(GenerateCheckoutTokenRequest) returns (GenerateCheckoutTokenResponse);
  rpc UpdateSubscription(UpdateSubscriptionRequest) returns (UpdateSubscriptionResponse);
  rpc SchedulePlanChange(SchedulePlanChangeRequest) returns (SchedulePlanChangeResponse);
  rpc PreviewPlanChange(PreviewPlanChangeRequest) returns (PreviewPlanChangeResponse);
  rpc CancelPlanChange(CancelPlanChangeRequest) returns (CancelPlanChangeResponse);
  rpc CancelScheduledEvent(CancelScheduledEventRequest) returns (CancelScheduledEventResponse);
  rpc GetUpcomingInvoice(GetUpcomingInvoiceRequest) returns (GetUpcomingInvoiceResponse);
  rpc GetSubscriptionComponentUsage(GetSubscriptionComponentUsageRequest) returns (GetSubscriptionComponentUsageResponse);
}

message IngestCsvRequest {
  FileData file = 1;
  string delimiter = 2;
  bool fail_on_error = 3;
}

message IngestCsvResponse {
  int32 total_rows = 1;
  int32 successful_rows = 2;
  repeated IngestionFailure failures = 3;
}

message IngestionFailure {
  int32 row_number = 1;
  string reason = 2;
}

message FileData {
  bytes data = 1;
}

service SubscriptionsIngestService {
  rpc IngestCsv(IngestCsvRequest) returns (IngestCsvResponse) {}
}
