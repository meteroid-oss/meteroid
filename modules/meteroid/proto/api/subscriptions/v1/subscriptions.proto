syntax = "proto3";

package meteroid.api.subscriptions.v1;


import "api/subscriptions/v1/models.proto";
import "common/v1/pagination.proto";

message CreateSubscriptionsRequest {
  repeated CreateSubscription subscriptions = 1;
}

message CreateSubscriptionRequest {
  CreateSubscription subscription = 1;
}

message CreateSubscriptionsResponse {
  repeated CreatedSubscription subscriptions = 1;
}

message CreateSubscriptionResponse {
  CreatedSubscription subscription = 1;
}

message GetSubscriptionDetailsRequest {
  string subscription_id = 1;
}

message GetSubscriptionDetailsResponse {
  SubscriptionDetails subscription = 1;
}



message CancelSubscriptionRequest {
  string subscription_id = 1;
  optional string reason = 2;

  oneof effective_at {
    Immediate immediate = 3;
    BillingPeriodEnd billing_period_end = 4;
    string date = 5;
  }
  message Immediate {}
  message BillingPeriodEnd {}

}

message CancelSubscriptionResponse {
  Subscription subscription = 1;
}



message ListSubscriptionsRequest {
  optional string customer_id = 1;
  optional string plan_id = 2;
  meteroid.common.v1.Pagination pagination = 3;
  repeated SubscriptionStatus status = 4;
}

message ListSubscriptionsResponse {
  repeated Subscription subscriptions = 1;
  meteroid.common.v1.PaginationResponse pagination_meta = 2;
}


message UpdateSlotsRequest {
  string subscription_id = 1;
  string price_component_id = 2;
  int32 delta = 3;
  optional SlotUpgradeBillingMode billing_mode = 4;
}

message UpdateSlotsResponse {
  uint32 current_value = 1;
}

message GetSlotsValueRequest {
  string subscription_id = 1;
  string unit = 2;
}

message GetSlotsValueResponse {
  uint32 current_value = 1;
  // uint32 next_period_value = 2; // TODO
}

message SyncToHubspotRequest {
  repeated string subscription_ids = 1;
}

message SyncToHubspotResponse {
}

message ListSlotTransactionsRequest {
  string subscription_id = 1;
  optional string unit = 2;
  optional SlotTransactionStatus status = 3;
}

message ListSlotTransactionsResponse {
  repeated SlotTransaction transactions = 1;
}

message CancelSlotTransactionRequest {
  string transaction_id = 1;
  optional string reason = 2;
}

message CancelSlotTransactionResponse {}

message PreviewSlotUpdateRequest {
  string subscription_id = 1;
  string price_component_id = 2;
  int32 delta = 3;
}

message PreviewSlotUpdateResponse {
  int32 current_slots = 1;
  int32 new_slots = 2;
  int32 delta = 3;
  string unit = 4;
  string unit_rate = 5;

  // Proration details
  string prorated_amount = 6; // Actual prorated charge
  string full_period_amount = 7; // What they'll pay per period going forward
  int32 days_remaining = 8; // Days left in current period
  int32 days_total = 9; // Total days in period

  string effective_at = 10;
  string current_period_end = 11;
  // How much will be added to next invoice
  string next_invoice_delta = 12;
}

message GenerateCheckoutTokenRequest {
  string subscription_id = 1;
}

message GenerateCheckoutTokenResponse {
  string token = 1;
}


// Service definition
service SubscriptionsService {
  rpc CreateSubscription(CreateSubscriptionRequest) returns (CreateSubscriptionResponse);
  rpc CreateSubscriptions(CreateSubscriptionsRequest) returns (CreateSubscriptionsResponse);
  rpc GetSubscriptionDetails(GetSubscriptionDetailsRequest) returns (SubscriptionDetails);
  rpc ListSubscriptions(ListSubscriptionsRequest) returns (ListSubscriptionsResponse);
  rpc UpdateSlots(UpdateSlotsRequest) returns (UpdateSlotsResponse);
  rpc GetSlotsValue(GetSlotsValueRequest) returns (GetSlotsValueResponse);
  rpc ListSlotTransactions(ListSlotTransactionsRequest) returns (ListSlotTransactionsResponse);
  rpc CancelSlotTransaction(CancelSlotTransactionRequest) returns (CancelSlotTransactionResponse);
  rpc PreviewSlotUpdate(PreviewSlotUpdateRequest) returns (PreviewSlotUpdateResponse);
  rpc CancelSubscription(CancelSubscriptionRequest) returns (CancelSubscriptionResponse);
  rpc SyncToHubspot(SyncToHubspotRequest) returns (SyncToHubspotResponse);
  rpc GenerateCheckoutToken(GenerateCheckoutTokenRequest) returns (GenerateCheckoutTokenResponse);
}
