name: Preview â€“ Run

# Architecture:
#   GitHub Actions runner (ubuntu-latest) runs everything locally:
#     postgres  (docker compose)
#     backend   (cargo watch --bin standalone)
#     frontend  (pnpm run dev)
#     frpc      (tunnels runner ports â†’ frps on Hetzner)
#
#   Traffic flow:
#     user â†’ Cloudflare â†’ Hetzner:80 â†’ frps â†’ tunnel â†’ frpc on runner â†’ localhost
#
# Required GitHub Secrets:
#   PREVIEW_FRP_TOKEN  â€” frp auth token (omit/empty if frps has no auth)
#
# Required GitHub Variables (Settings â†’ Variables):
#   PREVIEW_BASE_DOMAIN  â€” e.g. preview.meteroid.dev  (default: preview.meteroid.dev)
#   PREVIEW_FRP_SERVER   â€” frps hostname               (default: preview.meteroid.dev)
#   PREVIEW_FRP_PORT     â€” frps control port           (default: 7000)
#   PREVIEW_FRPC_VERSION â€” frp release version         (default: 0.61.1)
#
# Port layout (remote ports on Hetzner must be open in firewall):
#   Frontend  http://pr-N.BASE_DOMAIN       frp HTTP vhost  â†’  runner:5173
#   gRPC      BASE_DOMAIN:60000+N           frp TCP         â†’  runner:50061
#   REST      BASE_DOMAIN:62000+N           frp TCP         â†’  runner:8084

run-name: Preview PR #${{ inputs.pr_number }}

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number'
        required: true
        type: string

# One active preview per PR; a new /preview cancels the previous one
concurrency:
  group: preview-pr-${{ inputs.pr_number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  preview:
    name: Preview PR #${{ inputs.pr_number }}
    runs-on: ubuntu-latest
    timeout-minutes: 360   # 6-hour hard cap

    env:
      PR_NUMBER:   ${{ inputs.pr_number }}
      BASE_DOMAIN: ${{ vars.PREVIEW_BASE_DOMAIN || 'preview.meteroid.dev' }}
      FRP_SERVER:  ${{ vars.PREVIEW_FRP_SERVER  || 'preview.meteroid.dev' }}
      FRP_PORT:    ${{ vars.PREVIEW_FRP_PORT    || '7000' }}
      FRP_TOKEN:   ${{ secrets.PREVIEW_FRP_TOKEN }}
      FRPC_VER:    ${{ vars.PREVIEW_FRPC_VERSION || '0.61.1' }}

    steps:
      # â”€â”€ Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: actions/checkout@v4

      # â”€â”€ PR metadata â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Get PR info
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          INFO=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER)
          BRANCH=$(echo "$INFO" | jq -r '.head.ref')
          SHA=$(echo "$INFO" | jq -r '.head.sha')
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "sha=$SHA"       >> $GITHUB_OUTPUT

          # Pre-compute preview URLs (deterministic from PR number)
          echo "frontend_url=http://pr-${PR_NUMBER}.${BASE_DOMAIN}"                >> $GITHUB_OUTPUT
          echo "grpc_url=http://${BASE_DOMAIN}:$((60000 + PR_NUMBER))"             >> $GITHUB_OUTPUT
          echo "rest_url=http://${BASE_DOMAIN}:$((62000 + PR_NUMBER))"             >> $GITHUB_OUTPUT

      # â”€â”€ Post "starting" placeholder comment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Post starting comment
        id: comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SHA_SHORT="${{ steps.pr.outputs.sha }}"
          ID=$(gh api repos/${{ github.repository }}/issues/$PR_NUMBER/comments \
            --method POST \
            -f body="## ðŸ”„ Preview Environment Startingâ€¦

          > â³ Building Rust backend â€” first build can take **10â€“15 min** on a cold cache.

          **Branch:** \`${{ steps.pr.outputs.branch }}\` @ \`${SHA_SHORT:0:8}\`
          **Workflow:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ---
          ðŸ›‘ Comment \`/stop-preview\` to stop." \
            --jq '.id')
          echo "comment_id=$ID"      >> $GITHUB_OUTPUT
          echo "PREVIEW_COMMENT_ID=$ID" >> $GITHUB_ENV

      # â”€â”€ Free disk space (Rust build artefacts need room) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Free disk space
        run: |
          df -h
          sudo apt-get remove -y '^llvm-.*' 'php.*' azure-cli google-cloud-sdk \
            google-chrome-stable firefox powershell mono-devel 2>/dev/null || true
          sudo apt-get autoremove -y && sudo apt-get clean
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc \
            /opt/hostedtoolcache /usr/lib/jvm /usr/local/julia* \
            /usr/local/share/chromium /opt/microsoft /opt/google /opt/az \
            /usr/local/.ghcup
          sudo docker image prune -af
          df -h

      # â”€â”€ Rust toolchain + build cache â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: ./.github/actions/rust-setup

      - name: Install cargo-watch
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-watch

      # â”€â”€ Node / pnpm â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: modules/web/pnpm-lock.yaml

      # â”€â”€ Write .env â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Write .env
        run: |
          cp .env.example .env
          # The runner is isolated, so default local ports are fine.
          # Only the external URLs (exposed via frp) need to reflect the tunnel.
          cat >> .env <<ENV

          ## â”€â”€ Preview overrides for PR #${PR_NUMBER} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          METEROID_API_EXTERNAL_URL=${{ steps.pr.outputs.grpc_url }}
          METEROID_REST_API_EXTERNAL_URL=${{ steps.pr.outputs.rest_url }}
          METEROID_PUBLIC_URL=${{ steps.pr.outputs.frontend_url }}
          VITE_METEROID_API_EXTERNAL_URL=${{ steps.pr.outputs.grpc_url }}
          VITE_METEROID_REST_API_EXTERNAL_URL=${{ steps.pr.outputs.rest_url }}
          ENV

      # â”€â”€ Postgres â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Start postgres
        run: |
          # Each runner is a fresh VM so no port/name conflicts
          docker compose \
            -f docker/develop/docker-compose-lite.yml \
            --env-file .env \
            up -d
          echo "Waiting for postgresâ€¦"
          until docker exec meteroid-db pg_isready -U meteroid -d meteroid 2>/dev/null; do
            sleep 2
          done
          echo "Postgres ready."

      # â”€â”€ Install frontend deps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install pnpm deps
        run: pnpm --prefix modules/web install

      # â”€â”€ Download frpc â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Download frpc
        run: |
          wget -qO /tmp/frp.tgz \
            "https://github.com/fatedier/frp/releases/download/v${FRPC_VER}/frp_${FRPC_VER}_linux_amd64.tar.gz"
          tar -xzf /tmp/frp.tgz -C /tmp
          echo "FRPC=/tmp/frp_${FRPC_VER}_linux_amd64/frpc" >> $GITHUB_ENV

      # â”€â”€ Write frpc config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Configure frpc
        run: |
          GRPC_REMOTE=$(( 60000 + PR_NUMBER ))
          REST_REMOTE=$(( 62000 + PR_NUMBER ))

          {
            cat <<FRPC
          serverAddr = "${FRP_SERVER}"
          serverPort = ${FRP_PORT}
          FRPC

            if [[ -n "$FRP_TOKEN" ]]; then
              cat <<FRPC_AUTH

          [auth]
          method = "token"
          token = "${FRP_TOKEN}"
          FRPC_AUTH
            fi

            cat <<FRPC_PROXIES

          # Frontend via HTTP vhost (frps routes pr-N.BASE_DOMAIN â†’ runner:5173)
          [[proxies]]
          name = "pr-${PR_NUMBER}-frontend"
          type = "http"
          localPort = 5173
          customDomains = ["pr-${PR_NUMBER}.${BASE_DOMAIN}"]
          hostHeaderRewrite = "127.0.0.1"

          # gRPC â€” TCP passthrough
          [[proxies]]
          name = "pr-${PR_NUMBER}-grpc"
          type = "tcp"
          localPort = 50061
          remotePort = ${GRPC_REMOTE}

          # REST API â€” TCP passthrough
          [[proxies]]
          name = "pr-${PR_NUMBER}-rest"
          type = "tcp"
          localPort = 8084
          remotePort = ${REST_REMOTE}
          FRPC_PROXIES
          } > /tmp/frpc.toml

          echo "frpc config written (remote gRPC=${GRPC_REMOTE}, REST=${REST_REMOTE})"

      # â”€â”€ Build backend first (so we can report failures before starting loop)
      - name: Build backend
        run: cargo build --bin standalone

      # â”€â”€ Start all services in the background â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Start services
        run: |
          mkdir -p /tmp/preview-pids

          # frpc â€” outbound tunnel to Hetzner frps
          $FRPC -c /tmp/frpc.toml &
          echo $! > /tmp/preview-pids/frpc.pid
          echo "frpc started (pid $(cat /tmp/preview-pids/frpc.pid))"

          # Backend â€” cargo-watch auto-recompiles on .rs changes from git pull
          set -a && source .env && set +a
          cargo watch --why -x 'run --bin standalone' &
          echo $! > /tmp/preview-pids/backend.pid
          echo "backend started (pid $(cat /tmp/preview-pids/backend.pid))"

          # Frontend â€” Vite HMR picks up .ts/.tsx changes from git pull
          pnpm --prefix modules/web/web-app run dev -- --host 0.0.0.0 &
          echo $! > /tmp/preview-pids/frontend.pid
          echo "frontend started (pid $(cat /tmp/preview-pids/frontend.pid))"

          # Wait for gRPC port to be up (confirms backend compiled + started)
          echo "Waiting for backend on :50061â€¦"
          WAITED=0
          until nc -z localhost 50061 2>/dev/null; do
            sleep 5; WAITED=$((WAITED+5))
            (( WAITED >= 900 )) && echo "Backend not ready after 15 min" && exit 1
          done
          echo "Backend ready."

          # Wait for Vite
          echo "Waiting for frontend on :5173â€¦"
          WAITED=0
          until nc -z localhost 5173 2>/dev/null; do
            sleep 2; WAITED=$((WAITED+2))
            (( WAITED >= 120 )) && echo "Frontend not ready after 2 min" && exit 1
          done
          echo "Frontend ready."

      # â”€â”€ Update PR comment with live URLs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Update comment with URLs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FRONTEND="${{ steps.pr.outputs.frontend_url }}"
          GRPC="${{ steps.pr.outputs.grpc_url }}"
          REST="${{ steps.pr.outputs.rest_url }}"
          SHA_SHORT="${{ steps.pr.outputs.sha }}"

          gh api repos/${{ github.repository }}/issues/comments/$PREVIEW_COMMENT_ID \
            --method PATCH \
            -f body="## âœ… Preview Environment Ready

          | Service | URL |
          |---------|-----|
          | ðŸŒ Frontend | [${FRONTEND}](${FRONTEND}) |
          | âš¡ gRPC API | \`${GRPC}\` |
          | ðŸ”Œ REST API | \`${REST}\` |

          **Branch:** \`${{ steps.pr.outputs.branch }}\` @ \`${SHA_SHORT:0:8}\`

          ðŸ’¡ Auto-updates on every push (cargo-watch + Vite HMR).
          ðŸ›‘ Comment \`/stop-preview\` to stop.

          _Triggered by: @${{ github.actor }}_"

      # â”€â”€ Watch for PR changes (blocks until cancelled) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Watch for PR changes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BRANCH: ${{ steps.pr.outputs.branch }}
        run: |
          # Allow git to fetch with the built-in token
          git remote set-url origin \
            "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git"

          LAST_SHA=$(git rev-parse HEAD)
          echo "Watching branch ${PR_BRANCH} (current: ${LAST_SHA:0:8}) â€” polling every 60 s"
          echo "Job will run for up to 6 hours. Cancel via /stop-preview or the Actions UI."

          while true; do
            sleep 60

            git fetch origin "${PR_BRANCH}" --quiet 2>/dev/null || continue

            NEW_SHA=$(git rev-parse "origin/${PR_BRANCH}" 2>/dev/null || echo "")
            [[ -z "$NEW_SHA" || "$NEW_SHA" == "$LAST_SHA" ]] && continue

            echo "$(date -u '+%H:%M:%S') Update detected: ${LAST_SHA:0:8} â†’ ${NEW_SHA:0:8}"
            git reset --hard "origin/${PR_BRANCH}"

            # Reinstall pnpm deps if manifest changed, then restart Vite
            CHANGED=$(git diff --name-only "$LAST_SHA" "$NEW_SHA" 2>/dev/null || echo "")
            if echo "$CHANGED" | grep -qE 'pnpm-lock\.yaml|package\.json'; then
              echo "Package changes detected â€” reinstalling pnpm deps and restarting frontendâ€¦"
              kill "$(cat /tmp/preview-pids/frontend.pid 2>/dev/null)" 2>/dev/null || true
              pnpm --prefix modules/web install
              set -a && source .env && set +a
              pnpm --prefix modules/web/web-app run dev -- --host 0.0.0.0 &
              echo $! > /tmp/preview-pids/frontend.pid
            fi

            # cargo-watch detects .rs changes and auto-recompiles â€” no action needed
            echo ".rs changes will be picked up automatically by cargo-watch."

            LAST_SHA="$NEW_SHA"
          done

      # â”€â”€ Cleanup (always runs, even on cancellation) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Cleanup
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Cleaning up preview environmentâ€¦"

          # Kill background processes
          for f in /tmp/preview-pids/*.pid 2>/dev/null; do
            [[ -f "$f" ]] && kill "$(cat "$f")" 2>/dev/null || true
          done

          # Stop postgres
          docker compose \
            -f docker/develop/docker-compose-lite.yml \
            --env-file .env \
            down -v 2>/dev/null || true

          # Update PR comment
          if [[ -n "${PREVIEW_COMMENT_ID:-}" ]]; then
            gh api "repos/${{ github.repository }}/issues/comments/${PREVIEW_COMMENT_ID}" \
              --method PATCH \
              -f body="## ðŸ›‘ Preview Environment Stopped

          The environment for PR #${PR_NUMBER} has been stopped and all resources cleaned up.

          Comment \`/preview\` to restart it." \
              2>/dev/null || true
          fi
