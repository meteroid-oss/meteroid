name: Preview – Dispatch

# Listens for /preview and /stop-preview comments on PRs.
# Validates commenter permissions, then triggers preview-run.yml via workflow_dispatch API.

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: write

jobs:
  dispatch:
    name: Dispatch preview command
    runs-on: ubuntu-latest
    # Only fire on PR comments with our slash commands
    if: |
      github.event.issue.pull_request != null &&
      (startsWith(github.event.comment.body, '/preview') ||
       startsWith(github.event.comment.body, '/stop-preview'))
    steps:
      - name: Check write permission
        id: perm
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            try {
              const { data } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: context.actor,
              });
              return ['admin', 'maintain', 'write'].includes(data.permission) ? 'true' : 'false';
            } catch (_) {
              return 'false';
            }

      - name: Deny unauthorized user
        if: steps.perm.outputs.result == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '⛔ Only collaborators with write access can manage preview environments.',
            });

      - name: React with rocket
        if: steps.perm.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket',
            });

      - name: Dispatch preview-run workflow
        if: steps.perm.outputs.result == 'true'
        uses: actions/github-script@v7
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
          PR_NUMBER: ${{ github.event.issue.number }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const action = process.env.COMMENT_BODY.startsWith('/stop-preview') ? 'stop' : 'start';
            const defaultBranch = context.payload.repository.default_branch;
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'preview-run.yml',
              ref: defaultBranch,
              inputs: {
                pr_number: process.env.PR_NUMBER,
                action: action,
              },
            });
            core.info(`Dispatched preview-run.yml with action=${action} for PR #${process.env.PR_NUMBER}`);
